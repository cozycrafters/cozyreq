[tools]
bun = "latest"
"github:supabase/cli" = "latest"
uv = "latest"
rust = "latest"

[settings]
python.uv_venv_auto = true

[env]
_.file = '.env'
OPENCODE_EXPERIMENTAL_OXFMT = "true"

# Development Tasks
[tasks.dev]
description = "Start all services (Supabase + FastAPI + Next.js) in parallel"
depends = ["db:start", "dev:api", "dev:web"]

[tasks."dev:web"]
description = "Start Next.js dev server only"
run = "bun run dev"
dir = "apps/web"

[tasks."dev:api"]
description = "Start FastAPI dev server only"
run = "uv run uvicorn src.main:app --reload --port 8000"
dir = "apps/api"

[tasks."dev:cli"]
description = "Build and run CLI in dev mode"
run = "cargo run"
dir = "apps/cli"

# Database Tasks
[tasks."db:start"]
description = "Start Supabase local stack"
run = "supabase start"

[tasks."db:stop"]
description = "Stop Supabase"
run = "supabase stop"

[tasks."db:reset"]
description = "Reset Supabase (useful for testing)"
run = "supabase db reset"

[tasks."db:migrate"]
description = "Run Supabase migrations"
run = "supabase migration up"

# Testing Tasks
[tasks.test]
description = "Run all test suites"
depends = ["test:web", "test:api", "test:cli"]

[tasks."test:web"]
description = "Run Next.js tests with oxlint"
run = "bun run lint"
dir = "apps/web"

[tasks."test:api"]
description = "Run FastAPI tests"
run = "uv run pytest"
dir = "apps/api"

[tasks."test:cli"]
description = "Run Rust CLI tests"
run = "cargo test"
dir = "apps/cli"

# Quality Tasks
[tasks.lint]
description = "Run all linters: oxlint (Web), ruff (API), clippy (CLI)"
depends = ["lint:web", "lint:api", "lint:cli"]

[tasks."lint:web"]
description = "Run oxlint for JavaScript/TypeScript (Next.js)"
run = "bun run lint"
dir = "apps/web"

[tasks."lint:api"]
description = "Run ruff for Python (FastAPI)"
run = "uv run ruff check"
dir = "apps/api"

[tasks."lint:cli"]
description = "Run clippy for Rust (CLI)"
run = "cargo clippy -- -D warnings"
dir = "apps/cli"

[tasks.format]
description = "Run all formatters: oxfmt (Web), ruff (API), rustfmt (CLI)"
depends = ["format:web", "format:api", "format:cli"]

[tasks."format:web"]
description = "Run oxfmt for JavaScript/TypeScript (Next.js)"
run = "bun run format"
dir = "apps/web"

[tasks."format:api"]
description = "Run ruff format for Python (FastAPI)"
run = "uv run ruff format"
dir = "apps/api"

[tasks."format:cli"]
description = "Run rustfmt for Rust (CLI)"
run = "cargo fmt"
dir = "apps/cli"

# Setup Task
[tasks.setup]
description = "Initial setup: install dependencies, initialize Supabase, set up environment"
depends = ["setup:deps", "setup:supabase"]

[tasks."setup:deps"]
description = "Install all dependencies (bun, cargo, uv)"
run = """
bun install
cargo fetch --manifest-path apps/cli/Cargo.toml
uv sync
uv sync --project apps/api
"""

[tasks."setup:supabase"]
description = "Initialize Supabase (if not already initialized)"
run = "supabase init --yes || echo 'Supabase already initialized'"
